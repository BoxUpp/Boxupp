var ngBoxuppApp = angular.module('boxuppApp');

ngBoxuppApp.factory('User',function($http){
	return {
		login : function(userName, password){

			return $http({
		 				method: 'POST',
				 		url: '/boxupp/resources/user/login',
				 		data: angular.toJson({loginID : userName, password : password})
		 			}).then(function(result){
		 				return result.data;
		 			});
		},
		getProjects : function(userID){
			return $http({
		 				method: 'GET',
				 		url: '/boxupp/resources/user/getProjects/' + userID + '/',
		 			}).then(function(result){
		 				return result.data;
		 			});	
		},
		signup : function(newUserDetail){
			return $http({
		 				method: 'POST',
				 		url: '/boxupp/resources/user/signup/',
				 		data : angular.toJson(newUserDetail)
		 			}).then(function(result){
		 				return result.data;
		 			});	
		}
	}
});


ngBoxuppApp.factory('ResourcesData',function($http,$q){

	return {
		fetchBoxList : function(projectID){
			return $http({
		 				method: 'GET',
				 		url: '/boxupp/resources/project/getBoxes/' + projectID + '/',
		 			}).then(function(result){
		 				return result.data;
		 			});		
		},
		fetchScriptList : function(projectID){
			return $http({
		 				method: 'GET',
				 		url: '/boxupp/resources/project/getScripts/' + projectID + '/',
		 			}).then(function(result){
		 				return result.data;
		 			});			
		},
		fetchModuleList : function(projectID){
			return $http({
		 				method: 'GET',
				 		url: '/boxupp/resources/project/getModules/' + projectID + '/',
		 			}).then(function(result){
		 				return result.data;
		 			});				
		}
	}
	
});
ngBoxuppApp.factory('MachineConfig',function($resource){
		return $resource('/boxupp/resources/machineConfig/:id');
});

/*ngBoxuppApp.factory('MachineConfig',function($http,$q,$resource){
	var machineConfig = {};
	machineConfig.rs= function(){
		return $resource('/boxupp/resources/machineConfig/:id');
	};
	machineConfig.fetchList = function(projectID){
			return $http({
		 				method: 'GET',
				 		url: '/boxupp/resources/project/getBoxes/' + projectID + '/',
		 			}).then(function(result){
		 				return result.data;
		 			});		
		};
	return machineConfig;
});
*/ngBoxuppApp.factory('Projects',function($resource){
		return $resource('/boxupp/resources/project/:id');
});

ngBoxuppApp.factory('Providers',function($resource){
		return $resource('/boxupp/resources/provider/:id');
});


ngBoxuppApp.factory('retrieveMappings',function($http,$q,$timeout,$cacheFactory){
		return{
			fetchMappings : function(serverLocation,$scope){
				var completeURL = serverLocation + "/services/retrieveData";
				var $httpDefaultCache = $cacheFactory.get('$http');
				$httpDefaultCache.removeAll();
				var deferred = $q.defer();
				$http({	
					method:'GET',
					url:completeURL
				}).
				success(function(response, status, headers, config) {
					//if(response.fileExists){
						deferred.resolve(response);
					//}
				}).
				error(function(data, status, headers, config) {
					console.log(" : Error retrieving mappings from server : " + status);
					lockBoxupp = false;
				});
				return deferred.promise;
			}
		}
});

ngBoxuppApp.factory('vagrantStatus',function($http,$q,$timeout){
		return{
			updateVagrantStatus : function(serverLocation,$scope){
				var completeURL = serverLocation + "/services/checkVagrantStatus";
				var deferred = $q.defer();
				$http({	
					method:'GET',
					headers:{'Content-Type':'application/json; charset=UTF-8'},
					url:completeURL
				}).
				success(function(response, status, headers, config) {
						$scope.boxuppConfig.vagrantExecutionFlag = response.statusCode;
						deferred.resolve(response);
				}).
				error(function(data, status, headers, config) {
						console.log(" : Error checking vagrant status : ");
				});
				return deferred.promise;
			}
			}
	
});

ngBoxuppApp.factory('executeCommand',function($http,$q,$timeout){
		return{
			
			triggerVagrant : function(serverLocation,$scope){
				if (!window.WebSocket){
					console.log("WebSocket not supported by this browser");
					var completeURL = $scope.serverAddress + "/services/boxupp?command=" + $scope.deployCommand;
					$http({		
						method:'GET',
						headers:{'Content-Type':'application/json; charset=UTF-8'},
						url:completeURL
					}).
					success(function(data, status, headers, config) {
						$scope.resetFlags();
						$scope.fetchVagrantOutput();
					}).
					error(function(data, status, headers, config) {
						console.log("Error executing Vagrant command : " + data);
					});
				}else{
					console.log("Websocket supported");
					$scope.server.connect();
					$scope.waitForWSConnection(function(){
						$scope.server.send($scope.deployCommand);
					});
					
				}
				
			},
			saveBoxuppData : function(serverLocation,$scope){
				var boxuppMappings = {"vmData":$scope.boxesData,"shellScripts":$scope.shellScripts,"puppetData":$scope.puppet};
				var completeURL = $scope.serverAddress + "/services/saveAsFile";
				var deferred = $q.defer();
				$http({	
						method:'POST',
						headers:{'Content-Type':'application/json; charset=UTF-8'},
						url:completeURL,
						data:boxuppMappings
					}).
				success(function(data, status, headers, config) {
					if(data.fileCreated){
						console.log("Vagrant File Saved at : " + data.fileCreationPath);
						$scope.resetFlags();
						$scope.flushVagrantOutputConsole();
						deferred.resolve(data);
					}
				}).
				error(function(data, status, headers, config) {
					console.log("Error saving Boxupp Data: " + data);
				});
				return deferred.promise;
			}
		}
});

ngBoxuppApp.factory('fileUpload',function($http,$q,$timeout){
		return{
			changeDestination : function($scope,destination){
				var completeURL;
				if(destination !== null){
					completeURL = $scope.$parent.serverAddress + "/services/uploadHandler/destination?loc="+destination;
				}else{
					completeURL = $scope.$parent.serverAddress + "/services/uploadHandler/destination";
				}
				
				var deferred = $q.defer();
				$http({	
					method:'POST',
					headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},
					url:completeURL,
				}).
				success(function(response, status, headers, config) {
					deferred.resolve(response);
				}).
				error(function(data, status, headers, config) {
						console.log(" : Error updating file location : ");
				});
				return deferred.promise;
			}
		}
});

ngBoxuppApp.factory('puppetModule',function($http,$q,$timeout){
	return{
		searchPuppetModule : function($scope, searchModule){
			var parameters = {"query":searchModule,"owner":"","tag":"","show_deleted":"","sort_by":"","operatingsystem":"redhat","supported":"","pe_requirement":"","puppet_requirement":"","limit":"20","offset":"","If-Modified-Since":"Mon, 16 Dec 2013 22:09:00 GMT"};
			var completeURL = "/boxupp/searchPuppetModule";
			var deferred = $q.defer();
			$http({	
				method:'GET',
				headers:{'Content-Type':'application/json; charset=UTF-8'},
				url:completeURL,
				params:parameters
			}).	success(function(response, status, headers, config) {
				deferred.resolve(response);
			}).	error(function(response, status, headers, config) {
				console.log("Error saving Boxupp Data: " + response);
			});
			return deferred.promise;
		},
		
		downloadPuppetModule : function($scope,fileUrl, location){
			var filedata = {"fileUrl":"https://forgeapi.puppetlabs.com:443"+fileUrl, "loc":location}
			var completeURL = $scope.serverAddress + "/services/downloadPuppetModule";
			var deferred = $q.defer();
			$http({	
				method:'GET',
				headers:{'Content-Type':'application/json; charset=UTF-8'},
				url:completeURL,
				params:filedata
			}).success(function(response, status, headers, config) {
				console.log(response);
				deferred.resolve(response);
			}).error(function(response, status, headers, config) {
				console.log("Error downloading  Data: " + response);
			});
			return deferred.promise;
		}

	}	
});


ngBoxuppApp.factory('shellScript',function($resource){
	 return $resource('/boxupp/resources/shellScript/:id');
});

ngBoxuppApp.factory('miscUtil',function($filter){
	return{
		fetchCurrentTime : function(){
			return $filter('date')(new Date().getTime(), "yyyy'-'MM'-'dd HH':'mm':'ss");
		}
	}
});
